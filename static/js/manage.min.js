$((function(){$("#danmu-logout").show();var currentDataLength=-1,currentSelected=-1,lazyLoadTimer,firstPressTime=0,keyCaptureOn=!0;toastr.options={progressBar:!0,timeOut:2e3};var loadData=function(){$.ajax({type:"GET",url:"/danmu/super-admin/get/?verifier="+$("#verifier-select").val(),timeout:5e3,cache:!1,success:function(r){var finallist=r,finalhtml="";currentDataLength=finallist.length,currentSelected=0,finallist.forEach(e=>{finalhtml+=`<tr class="row mx-0" v-data="${e._id}"><td v-bind="cursor" class="col-1"></td><td title="${e.text}" class="col-5">${e.text}</td><td class="col-4">${e.username}</td><td class="col-2"></td></tr>`}),$("#result-container").html(finalhtml),$("#status-monitor").removeClass("text-warning").removeClass("text-danger").addClass("text-success").text("连接成功"),currentDataLength>0?(clearInterval(lazyLoadTimer),lazyLoadTimer=void 0,$("#result-container").find("tr").eq(0).find("td").eq(0).text(">"),tagAsActive(0)):null==lazyLoadTimer&&(lazyLoadTimer=setInterval(loadData,5e3))},error:function(r,t,x){$("#status-monitor").removeClass("text-warning").removeClass("text-success").addClass("text-danger").text("连接失败 "+t)}})},tagAsActive=function(nth){$("#result-container").find("tr").eq(nth).addClass("table-info").siblings().removeClass("table-info")},tagAsDelete=function(nth){var element=$("#result-container").find("tr").eq(nth).find("td").eq(3);""==element.html()?element.html('<i class="fas fa-check"></i>'):element.html("")},packToServer=function(){currentDataLength<=0||(accept_id=[],delete_id=[],$("#result-container").find("tr").each((function(){var node=$(this),is_delete;""!=node.find("td").eq(3).html()?delete_id.push(node.attr("v-data")):accept_id.push(node.attr("v-data"))})),$.post("/danmu/super-admin/operation/",{accept_id:accept_id,delete_id:delete_id},(function(r){toastr.success("审核数据提交成功！","提示"),loadData()})))};$("#banuser-ban-btn").click((function(){swal("请输入用户学号",{content:"input",icon:"info",dangerMode:!0,buttons:!0}).then(value=>{value&&""!=value&&$.post("/danmu/super-admin/banuser/",{username:value},(function(r){1==r.status?swal("操作结果","封禁成功！","success"):swal("操作结果","封禁失败！","error"),loadBannedUser()}))})})),$("#banuser-rec-btn").click((function(){swal("请输入用户学号",{content:"input",icon:"info",dangerMode:!0,buttons:!0}).then(value=>{value&&""!=value&&$.post("/danmu/super-admin/recoveruser/",{username:value},(function(r){1==r.status?swal("操作结果","解禁成功！","success"):swal("操作结果","解禁失败！","error"),loadBannedUser()}))})})),$("#verifier-select").change((function(){loadData()})),$(document).keydown((function(event){if(!1===keyCaptureOn)return!0;switch(event.keyCode){case 83:return currentSelected<currentDataLength-1&&($("#result-container").find("tr").eq(currentSelected++).find("td").eq(0).text(""),$("#result-container").find("tr").eq(currentSelected).find("td").eq(0).text(">"),tagAsActive(currentSelected)),!1;case 87:return currentSelected>0&&($("#result-container").find("tr").eq(currentSelected--).find("td").eq(0).text(""),$("#result-container").find("tr").eq(currentSelected).find("td").eq(0).text(">"),tagAsActive(currentSelected)),!1;case 65:return tagAsDelete(currentSelected),!1;case 68:var firstTime=(new Date).getTime();if(0==firstPressTime)firstPressTime=firstTime;else{var lastTime=(new Date).getTime();console.log("CURRENT timestamp",lastTime),console.log("Time elapse",lastTime-firstPressTime),lastTime-firstPressTime<800?(packToServer(),firstPressTime=0):firstPressTime=lastTime}return!1}return!0})),$("#result-container").click((function(e){var element=$(e.target).parent("tr"),indexes=$("#result-container tr").index(element);currentSelected==indexes?tagAsDelete(indexes):(currentSelected=indexes,$("#result-container").find("tr").each((function(){$(this).find("td").eq(0).text("")})),$("#result-container").find("tr").eq(currentSelected).find("td").eq(0).text(">"),tagAsActive(currentSelected))}));var loadBannedUser=function(){$.get("/danmu/super-admin/getbanneduser/",(function(r){var finalhtml="";r.forEach(e=>{finalhtml+=`<tr><td>${e.username}</td><td>${e.operator}</td></tr>`}),$("#banned-users").html(finalhtml)}))},loadBan=function(){loadBannedUser(),$("#banModal").modal("show"),keyCaptureOn=!1},loadVerifier=function(){for(var verify=$("#verifier-select"),html_text="",i=1;i<=Number(verify.attr("count"));i++)html_text+=`<option value="${i}">${i}</option>`;verify.html(html_text)},manualSubmit=function(){swal("确认",{text:"是否确认提交审核数据？",icon:"warning",buttons:!0}).then(value=>{value&&""!=value&&packToServer()})},dismissBanDialog=function(){keyCaptureOn=!0};$(document).ready((function(){window.loadBan=loadBan,window.manualSubmit=manualSubmit,window.dismissBanDialog=dismissBanDialog,loadVerifier(),loadData()}))}));